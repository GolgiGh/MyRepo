var mongoose = require('mongoose');

const getMongoUrl = (data) => {
    if (data.mongodb_ssl === "true") {
      return (
        "mongodb://" +
        data.mongodb_user +
        ":" +
        data.mongodb_pass +
        "@" +
        data.mongodb_ip +
        "/" +
        data.mongodb_database +
        `?authSource=${data.mongodb_database}&ssl=true&sslValidate=false&retryWrites=false`
      );
    } else {
      return data.mongodb_user && data.mongodb_pass
        ? `mongodb://${data.mongodb_user}:${data.mongodb_pass}@${data.mongodb_ip}/${data.mongodb_database}?authSource=${data.mongodb_database}`
        : "mongodb://" + data.mongodb_ip + "/" + data.mongodb_database;
    }
};

const getMongoConnection = (data) => {
    const db = mongoose.createConnection(getMongoUrl(data), getMongoOptions());
    return db;
};

const getMongoOptions = () => {
    return {
      useNewUrlParser: true,
      useUnifiedTopology: true,
      useCreateIndex: true, // avoid deprecation warning
    };
};

module.exports = {
    getMongoUrl,
    getMongoConnection,
    getMongoOptions
}